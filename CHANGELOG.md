# 更新日志

## v1.0.13 (2024-03-24)

### 改进
- 优化配置文件加载逻辑，优先使用 env.yaml
- 按以下顺序查找配置文件：
  1. 环境变量 TG_FORWARD_CONFIG
  2. 当前目录的 env.yaml
  3. /etc/tg-forward/env.yaml
  4. 用户主目录的 .tg-forward/env.yaml
  5. 当前目录的 config.yaml
  6. /etc/tg-forward/config.yaml
  7. 默认使用 env.yaml

## v1.0.12 (2024-03-24)

### 修复
- 修复了 LevelDB 队列目录权限问题
- 将队列存储路径修改为相对路径 `./data/queue`
- 优化了队列目录的创建和权限检查逻辑

## v1.0.11 (2024-03-24)

### 修复
- 修复了 LevelDB 队列目录创建失败的问题
- 优化了队列目录的创建和权限检查逻辑
- 确保创建完整的队列目录路径而不是只创建父目录

### 优化
- 优化日志输出格式，确保文件和控制台输出一致
- 修复日志级别设置不生效的问题
- 改进日志文件写入机制，使用 Hook 实现同时写入文件和控制台

## v1.0.10 (2024-03-24)

### 优化
- 优化日志输出格式，确保文件和控制台输出一致
- 修复日志级别设置不生效的问题
- 改进日志文件写入机制，使用 Hook 实现同时写入文件和控制台

## v1.0.9 (2025-03-11)

### 新增
- 添加了日志文件支持，可以将日志写入指定文件
- 在配置文件中添加了日志配置选项，包括日志级别、文件路径等
- 支持日志文件的自动轮转和管理

### 改进
- 优化了日志级别的设置逻辑，支持从配置文件和命令行参数设置
- 同时支持输出到文件和控制台，方便查看和管理

## v1.0.8 (2025-03-11)

### 改进
- 在转发消息时添加了群组名称显示
- 优化了消息格式，使用 【群组名】[用户名] 的格式
- 当群组名称不可用时，使用群组 ID 作为替代显示

## v1.0.7 (2025-03-11)

### 修复
- 修复了 LevelDB 队列注册时机的问题，导致"不支持的队列类型"错误
- 优化了队列工厂的注册机制，将注册逻辑移至 init 函数中
- 改进了内存队列和 LevelDB 队列的初始化流程

## v1.0.6 (2025-03-11)

### 改进
- 优化了队列目录的创建和权限检查逻辑
- 增加了队列目录写权限的自动检测
- 改进了队列初始化的错误处理机制
- 优化了内存队列作为备用方案的切换逻辑

### 修复
- 修复了队列目录不存在时的自动创建功能
- 修复了队列初始化时的错误处理逻辑

## v1.0.5 (2025-03-11)

### 修复
- 修复了 LevelDB 队列创建时可能出现的"resource temporarily unavailable"错误
- 增强了 LevelDB 队列的错误处理和恢复机制
- 添加了自动降级到内存队列的功能，当 LevelDB 队列创建失败时

### 改进
- 增加了更详细的日志记录，以便更好地诊断问题
- 增强了对文件系统权限和锁定状态的检查

## [1.0.11] - 2024-03-21

### 新增
- 增加钉钉机器人 @ 功能的开关配置
- 支持通过配置文件控制是否启用 @ 功能
- 支持配置 @ 指定手机号或 @ 所有人

## v1.0.14 (2024-03-24)

### 修复
- 修复了 LevelDB 队列目录创建失败的问题
- 改进了队列目录创建逻辑，确保创建完整的目录路径
- 优化了目录权限检查，使用完整路径进行检查

## v1.0.15 (2024-03-24)

### 优化
- 优化 LevelDB 队列创建逻辑，提高稳定性
- 增加详细的错误处理和日志记录
- 添加对旧锁文件的清理逻辑
- 优化 LevelDB 配置选项，启用同步写入和写入合并

## v1.0.16 (2024-03-24)

### 优化
- 重构 LevelDB 队列的创建逻辑，增加更多错误处理和日志记录
- 优化 LevelDB 配置选项，提高数据库稳定性
- 改进队列目录权限检查和错误处理
- 优化备用内存队列的创建流程

## v1.0.17 (2024-03-24)

### 修复
- 修复了 LevelDB 队列初始化时的语法错误
- 优化了队列工厂函数的注册逻辑
- 改进了队列创建的日志记录

## v1.0.18 (2024-03-24)

### 优化
- 重构 LevelDB 队列的目录检查和创建逻辑
- 优化目录权限检查的顺序
- 增加更详细的日志记录
- 优化 LevelDB 数据库配置参数

## v1.0.19 (2024-03-24)

### 修复
- 修复了配置包导入路径错误的问题
- 统一使用 internal/config 包
- 解决了 LevelDB 队列路径配置不生效的问题

## v1.0.20 (2024-03-24)

### 修复
- 修复了聊天记录存储初始化失败的问题
- 修复了配置包导入路径错误的问题
- 优化了聊天记录数据库的配置参数
- 添加了自动创建数据库目录的功能

## [v1.0.21] - 2024-03-24

### 修复
- 修复了消息处理器中的编译错误
- 修正了 ChatInfoConfig 结构体字段名
- 修复了 ChatHistory 结构体字段映射问题

## [v1.0.22] - 2024-03-24

### 修复
- 修复了消息处理器中的编译错误
- 删除了未使用的 net 包导入
- 修正了 ChatConfig 类型为 ChatConfigWithID

## [v1.0.23] - 2024-03-24

### 修复
- 修复了消息处理器中的编译错误
- 修正了 GetChat 调用中的 ChatConfig 类型

## [v1.0.24] - 2024-03-24

### 修复
- 修复了消息处理器中的编译错误
- 修正了 GetChat 调用中的 ChatInfoConfig 类型

## [v1.0.25] - 2024-03-24

### 修复
- 修复了 BarkClient 初始化时的空指针引用错误
- 添加了对 Bark 配置为空的处理

## [2.0.0] - 2024-03-11

### 新增功能
- 增加 iOS Bark 通知支持
  - 支持多设备推送
  - 自定义通知声音
  - 自定义通知图标
  - 按聊天分组通知
- 增加聊天记录存储功能
  - 保存历史消息
  - 支持按时间查询
  - 支持按用户查询
- 增加 RPM 和 DEB 包安装支持
- 增加 systemd 和 SysV init 服务管理
- 增加队列指标收集，便于对接 Prometheus 监控
- 增加 HTTP 接口暴露队列指标数据

### 优化
- 重构消息处理流程，支持多目标转发
- 优化配置文件结构，增加更多配置选项
- 优化错误处理和日志记录
- 优化文档和安装说明
- 优化代码结构，增加模块化设计

### 修复
- 修复聊天记录存储初始化失败问题
- 修复配置文件路径问题
- 修复消息队列持久化问题
- 修复网络超时处理问题

## [2.0.1] - 2024-03-11

### 新增功能
- 增加 HarmonyOS_MeoW 通知支持
  - 支持多用户 ID 配置
  - 支持自定义 API 基础 URL
  - 支持图片消息处理
  - 支持消息跳转链接
- 优化图片处理逻辑
  - 支持 S3 存储图片
  - 自动选择最佳图片质量

### 优化
- 改进消息处理流程，支持多通知渠道
- 优化配置文件结构，增加 HarmonyOS_MeoW 配置部分
- 改进错误处理和日志记录

## [1.0.26] - 2024-03-14
### 修复
- 移除了未使用的包导入（net/url）以解决编译警告
  - 从 harmony.go 中移除
  - 从 message_handler.go 中移除

## [1.0.27] - 2024-03-14
### 修复
- 修复了 HarmonyOS_MeoW 通知 URL 中出现不正确字符的问题
  - 改进了 S3 URL 提取逻辑，确保完全清理 markdown 格式字符
  - 使用 LastIndex 确保正确获取 URL 结束位置
  - 添加了更详细的日志记录以便调试

## [1.0.28] - 2024-03-14
### 修复
- 修正了 HarmonyOS_MeoW 通知 URL 的格式问题
  - 将 "图片通知,请查看?url=" 改为 "图片通知?url="
  - 确保使用英文问号
  - 优化了 S3 URL 提取逻辑，简化了 markdown 字符清理过程

## [1.0.29] - 2024-03-14
### 改进
- 简化了 HarmonyOS_MeoW 通知的 URL 处理逻辑
  - 移除了复杂的 markdown 解析
  - 直接从消息内容中提取 S3 URL
  - 确保生成正确格式的通知 URL

## [1.0.30] - 2024-03-14
### 修复
- 修复了 HarmonyOS_MeoW 通知 URL 中包含 markdown 格式的问题
  - 改进了 S3 URL 提取逻辑，只提取实际的 URL 部分
  - 移除了 markdown 格式字符（如 ![预览]() 等）
  - 确保生成正确格式的通知 URL

## [1.0.31] - 2024-03-14
### 改进
- 优化了 HarmonyOS_MeoW 通知内容的处理逻辑
  - 图片消息：使用 "图片通知?url=<s3_url>" 格式
  - 文本消息：直接使用消息内容，不添加 url 参数
  - 添加了消息类型区分的日志记录

## [1.0.32] - 2024-03-14
### 改进
- 优化了 HarmonyOS_MeoW 文本消息的处理逻辑
  - 文本消息：直接发送纯文本内容，不添加任何额外参数
  - 移除了消息中的格式标记（如【】[]等）
  - 确保消息格式符合标准：域名/用户ID/群组/纯文本内容

所有版本的重要更改都将记录在此文件中。

## [1.0.4] - 2024-01-09

### 改进

- 添加 HTTP 服务暴露队列指标数据
- 提供 `/metrics` 接口返回 JSON 格式指标
- 提供 `/health` 接口用于健康检查
- 支持配置 HTTP 服务端口和路径
- 新增 HTTPS 支持：
  - 可配置 HTTPS 开关
  - 支持自定义证书和私钥
  - 支持 HTTP 到 HTTPS 自动重定向
  - 可选强制 HTTPS 模式
  - 支持自定义 HTTPS 端口
- 新增 HTTP 接口认证机制：
  - 支持 API Key 认证
  - 可配置认证开关
  - 可自定义 API Key 和请求头
  - 提供访问日志和安全警告
- 新增更多队列监控指标：
  - 消息处理延迟（平均延迟和 P95 延迟）
  - 队列吞吐量（每分钟处理消息数）
  - 消息处理成功率
  - 平均重试次数
  - 队列积压程度
  - 总运行时间
- 改进配置文件管理：
  - 指定默认配置路径为 `/etc/tg-forward/config.yaml`
  - 支持多级配置文件查找
  - 支持通过环境变量指定配置路径
  - 自动创建配置目录
  - 统一安装包中的配置文件路径
  - 规范化配置文件权限和所有权

## [1.0.3] - 2025-03-10

### 改进

- 添加队列指标收集功能
- 支持每分钟统计队列状态
- 支持将指标输出到 JSON 文件
- 为对接 Prometheus 监控做准备

## [1.0.2] - 2025-03-10

### 改进

- 添加 systemd 服务支持
- 添加 SysV init 服务脚本
- 添加 RPM 和 DEB 打包支持
- 优化 Linux 系统部署流程

## [1.0.1] - 2025-03-10

### 改进

- 优化错误处理逻辑
- 改进日志输出格式
- 增强网络超时检测

## [1.0.0] - 2025-03-10

### 新增

- 初始版本发布
- 支持监听 Telegram 群聊消息
- 支持转发消息到钉钉机器人
- 支持处理网络超时和错误情况
- 支持消息重试机制
- 支持内存队列和 LevelDB 持久化队列
- 支持程序重启后恢复失败消息